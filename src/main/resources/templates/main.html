<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>Products</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .modal { display: none; }
        .modal.active { display: flex; }
        .old-price {
            text-decoration: line-through;
            text-decoration-color: red;
            text-decoration-thickness: 2px;
        }
    </style>
</head>
<body class="font-sans bg-gray-100">
<!-- Top Bar -->
<div class="flex justify-between items-center px-4 py-3 bg-gray-100 border-b border-gray-300">
    <div class="font-semibold text-sm" th:text="${userName}">–ú–∞–π—è</div>
    <div class="flex gap-2">
        <button type="button" id="openOrdersBtn" class="px-3 py-1.5 text-xs rounded border border-blue-600 bg-white text-blue-600 hover:bg-blue-50 cursor-pointer">
            üìã My Orders
        </button>
        <button type="button" id="openCartBtn" class="px-3 py-1.5 text-xs rounded border border-emerald-600 bg-white text-emerald-600 hover:bg-emerald-50 cursor-pointer">
            üõí Cart
        </button>
        <button th:if="${userRole.name() != 'USER'}" class="px-3 py-1.5 text-xs rounded border border-emerald-600 bg-emerald-500 text-white hover:bg-emerald-600 cursor-pointer" type="button" onclick="openAddModal()">+ Product</button>
    </div>
</div>

<!-- Filters -->
<div class="flex gap-2 px-4 py-2.5 bg-white border-b border-gray-300">
    <form th:action="@{/}" method="get" id="searchForm" class="flex gap-2 w-full">
        <input type="text"
               name="search"
               id="searchInput"
               class="flex-1 px-2.5 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500"
               th:value="${param.search != null ? param.search[0] : ''}"
               placeholder="Search...">

        <select name="sort" id="sortSelect" th:value="${param.sort != null ? param.sort[0] : ''}"
                class="px-2.5 py-1.5 text-xs border border-gray-300 rounded cursor-pointer focus:outline-none focus:ring-2 focus:ring-emerald-500">
            <option value="">sort</option>
            <option value="titleAsc">By name (A-Z)</option>
            <option value="titleDesc">By name (Z-A)</option>
            <option value="costAsc">By price (low)</option>
            <option value="costDesc">By price (high)</option>
        </select>
    </form>
</div>

<!-- Products List -->
<div class="p-4 space-y-3">
    <div class="grid grid-cols-[120px_1fr_120px] gap-5 border border-gray-800 p-4 bg-white rounded" th:each="product : ${products}" th:data-product-id="${product.id}">
        <!-- Photo -->
        <div class="flex items-center">
            <div class="border border-gray-800 p-5 w-full min-h-[100px] flex items-center justify-center bg-gray-100">
                <img th:if="${product.photo != null}"
                     th:src="${@imageHelper.convertImageBytesToBase64(product.photo)}"
                     alt="Product photo"
                     class="max-w-full max-h-full">
                <img th:if="${product.photo == null}"
                     th:src="@{/picture.png}"
                     alt="No photo"
                     class="max-w-full max-h-full">
            </div>
        </div>

        <!-- Main information -->
        <div class="flex flex-col justify-center">
            <div class="font-bold mb-2 text-sm" th:text="${product.title}">Product name</div>
            <div class="mb-1.5 text-xs">
                <span class="font-semibold">Description: </span>
                <span th:text="${product.description}">Short description</span>
            </div>
            <div class="mb-1.5 text-xs">
                <span class="font-semibold">Manufacturer: </span>
                <span th:text="${product.manufacturer.title}">Manufacturer</span>
            </div>
            <div class="mb-1.5 text-xs">
                <span class="font-semibold">Price: </span>
                <span th:classappend="${product.discountAmount > 15} ? 'old-price'" th:text="${#numbers.formatDecimal(product.cost, 1, 2, 'DEFAULT')}">0.00</span>
                <span class="text-red-600 font-bold ml-2" th:if="${product.discountAmount > 15}" th:text="' ‚Üí ' + ${#numbers.formatDecimal(product.cost * (100 - product.discountAmount) / 100, 1, 2, 'DEFAULT')}"></span>
            </div>
            <div class="flex gap-1.5 mt-2">
                <button th:if="${userRole.name() != 'USER'}" class="px-2.5 py-1 text-[11px] rounded border border-emerald-600 bg-emerald-500 text-white hover:bg-emerald-600 cursor-pointer"
                        type="button"
                        th:attr="
                            data-id=${product.id},
                            data-title=${product.title},
                            data-description=${product.description},
                            data-category=${product.category.id},
                            data-cost=${product.cost},
                            data-quantityInStock=${product.quantityInStock},
                            data-unittype=${product.unitType.id},
                            data-manufacturer=${product.manufacturer.id},
                            data-supplier=${product.supplier.id},
                            data-discount=${product.discountAmount},
                            data-max-discount-amount=${product.maxDiscountAmount}"
                        onclick="openEditModal(this)">
                    Edit
                </button>
                <button th:if="${userRole.name() != 'USER'}" class="px-2.5 py-1 text-[11px] rounded border border-red-500 bg-red-500 text-white hover:bg-red-600 cursor-pointer delete-btn"
                        th:data-id="${product.id}">
                    Delete
                </button>
                <button class="px-2.5 py-1 text-[11px] rounded border border-emerald-600 bg-emerald-500 text-white hover:bg-emerald-600 cursor-pointer"
                        type="button"
                        th:data-id="${product.id}"
                        th:data-title="${product.title}"
                        th:data-cost="${product.cost}"
                        th:data-discount="${product.discountAmount}"
                        onclick="addToCart(this)">
                    üõí Add to Cart
                </button>
            </div>
        </div>

        <!-- Discount size -->
        <div class="flex items-center">
            <div class="flex flex-col items-center justify-center w-full border border-gray-800 py-5 px-2.5 min-h-[100px]">
                <span class="font-semibold text-xs">Discount</span>
                <span class="font-semibold text-xs">size</span>
                <span class="mt-1.5 text-xl font-bold" th:classappend="${product.discountAmount > 15} ? 'text-green-600' : ''" th:text="${product.discountAmount + '%'}">0%</span>
            </div>
        </div>
    </div>
</div>

<!-- EDIT MODAL WINDOW -->
<div id="editModal" class="modal fixed inset-0 z-50 bg-black/50 items-center justify-center">
    <div class="bg-white w-[90%] max-w-xl rounded shadow-xl max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center px-4 py-3 border-b bg-gray-100">
            <h2 class="text-base font-semibold">Edit Data</h2>
            <button class="text-xl text-gray-500 hover:text-black w-7 h-7 flex items-center justify-center" onclick="closeEditModal()">&times;</button>
        </div>
        <div class="p-5">
            <form id="editForm" th:action="@{/products/update/}" method="post" class="space-y-4">
                <div>
                    <label for="editTitle" class="block text-xs font-semibold mb-1.5">Name</label>
                    <input type="text" id="editTitle" name="title" class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500">
                </div>
                <div>
                    <label for="editDescription" class="block text-xs font-semibold mb-1.5">Description</label>
                    <textarea id="editDescription" name="description" class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded min-h-[80px] resize-y focus:outline-none focus:ring-2 focus:ring-emerald-500"></textarea>
                </div>
                <div>
                    <label for="editCategory" class="block text-xs font-semibold mb-1.5">Product Category</label>
                    <select id="editCategory" name="categoryId" class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500">
                        <option th:each="c : ${categories}" th:value="${c.id}" th:text="${c.title}"></option>
                    </select>
                </div>
                <div>
                    <label for="editCost" class="block text-xs font-semibold mb-1.5">Cost per Unit</label>
                    <input type="number" id="editCost" name="cost" step="0.01" required class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500">
                </div>
                <div>
                    <label for="editQuantity" class="block text-xs font-semibold mb-1.5">Quantity in Stock</label>
                    <input type="number" id="editQuantity" name="quantity" value="1" class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500">
                </div>
                <div>
                    <label for="editUnit" class="block text-xs font-semibold mb-1.5">Unit of Measurement</label>
                    <select id="editUnit" name="unitTypeId" class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500">
                        <option th:each="u : ${unittypes}" th:value="${u.id}" th:text="${u.title}"></option>
                    </select>
                </div>
                <div>
                    <label for="editManufacturer" class="block text-xs font-semibold mb-1.5">Manufacturer</label>
                    <select id="editManufacturer" name="manufacturerId" class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500">
                        <option th:each="m : ${manufacturers}" th:value="${m.id}" th:text="${m.title}"></option>
                    </select>
                </div>
                <div>
                    <label for="editSupplier" class="block text-xs font-semibold mb-1.5">Supplier</label>
                    <select id="editSupplier" name="supplierId" class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500">
                        <option th:each="s : ${suppliers}" th:value="${s.id}" th:text="${s.title}"></option>
                    </select>
                </div>
                <div>
                    <label for="editMaxDiscount" class="block text-xs font-semibold mb-1.5">Maximum Discount Size</label>
                    <input type="number" id="editMaxDiscount" name="maxDiscountAmount" min="0" max="100" required class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500">
                </div>
                <div>
                    <label for="editCurrentDiscount" class="block text-xs font-semibold mb-1.5">Current Discount Size</label>
                    <input type="number" id="editCurrentDiscount" name="discountAmount" min="0" max="100" required class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500">
                </div>
            </form>
        </div>
        <div class="flex gap-2 justify-end px-4 py-3 border-t bg-gray-100">
            <button class="px-4 py-2 text-xs font-semibold rounded bg-gray-200 text-gray-700 hover:bg-gray-300" onclick="closeEditModal()">Cancel</button>
            <button class="px-4 py-2 text-xs font-semibold rounded bg-emerald-500 text-white hover:bg-emerald-600" type="button" onclick="submitEditForm()">Save</button>
        </div>
    </div>
</div>

<!-- ADD PRODUCT MODAL WINDOW -->
<div id="addModal" class="modal fixed inset-0 z-50 bg-black/50 items-center justify-center">
    <div class="bg-white w-[90%] max-w-xl rounded shadow-xl max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center px-4 py-3 border-b bg-gray-100">
            <h2 class="text-base font-semibold">Add Product</h2>
            <button class="text-xl text-gray-500 hover:text-black w-7 h-7 flex items-center justify-center" onclick="closeAddModal()">&times;</button>
        </div>
        <div class="p-5">
            <form id="addForm" th:action="@{/products/create}" method="post" class="space-y-4">
                <div>
                    <label for="addTitle" class="block text-xs font-semibold mb-1.5">Name</label>
                    <input type="text" id="addTitle" name="title" class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500">
                </div>
                <div>
                    <label for="addDescription" class="block text-xs font-semibold mb-1.5">Description</label>
                    <textarea id="addDescription" name="description" class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded min-h-[80px] resize-y focus:outline-none focus:ring-2 focus:ring-emerald-500"></textarea>
                </div>
                <div>
                    <label for="addCategory" class="block text-xs font-semibold mb-1.5">Product Category</label>
                    <select id="addCategory" name="categoryId" class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500">
                        <option th:each="c : ${categories}" th:value="${c.id}" th:text="${c.title}"></option>
                    </select>
                </div>
                <div>
                    <label for="addCost" class="block text-xs font-semibold mb-1.5">Cost per Unit</label>
                    <input type="number" id="addCost" name="cost" step="0.01" required class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500">
                </div>
                <div>
                    <label for="addQuantity" class="block text-xs font-semibold mb-1.5">Quantity in Stock</label>
                    <input type="number" id="addQuantity" name="quantity" value="1" class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500">
                </div>
                <div>
                    <label for="addUnit" class="block text-xs font-semibold mb-1.5">Unit of Measurement</label>
                    <select id="addUnit" name="unitTypeId" class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500">
                        <option th:each="u : ${unittypes}" th:value="${u.id}" th:text="${u.title}"></option>
                    </select>
                </div>
                <div>
                    <label for="addManufacturer" class="block text-xs font-semibold mb-1.5">Manufacturer</label>
                    <select id="addManufacturer" name="manufacturerId" class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500">
                        <option th:each="m : ${manufacturers}" th:value="${m.id}" th:text="${m.title}"></option>
                    </select>
                </div>
                <div>
                    <label for="addSupplier" class="block text-xs font-semibold mb-1.5">Supplier</label>
                    <select id="addSupplier" name="supplierId" class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500">
                        <option th:each="s : ${suppliers}" th:value="${s.id}" th:text="${s.title}"></option>
                    </select>
                </div>
                <div>
                    <label for="addMaxDiscount" class="block text-xs font-semibold mb-1.5">Maximum Discount Size</label>
                    <input type="number" id="addMaxDiscount" name="maxDiscountAmount" value="20" min="0" max="100" required class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500">
                </div>
                <div>
                    <label for="addCurrentDiscount" class="block text-xs font-semibold mb-1.5">Current Discount Size</label>
                    <input type="number" id="addCurrentDiscount" name="discountAmount" min="0" max="100" required class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500">
                </div>
            </form>
        </div>
        <div class="flex gap-2 justify-end px-4 py-3 border-t bg-gray-100">
            <button class="px-4 py-2 text-xs font-semibold rounded bg-gray-200 text-gray-700 hover:bg-gray-300" onclick="closeAddModal()">Cancel</button>
            <button class="px-4 py-2 text-xs font-semibold rounded bg-emerald-500 text-white hover:bg-emerald-600" type="button" onclick="submitAddForm()">Add</button>
        </div>
    </div>
</div>

<!-- CART SIDEBAR MENU -->
<div id="cartOverlay" class="fixed inset-0 z-40 bg-black/50 hidden" onclick="closeCartModal()"></div>
<div id="cartSidebar" class="fixed top-0 right-0 z-50 h-full w-96 bg-white shadow-xl transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col">
    <div class="flex justify-between items-center px-4 py-3 border-b bg-gray-100">
        <h2 class="text-base font-semibold">üõí Cart</h2>
        <button class="text-xl text-gray-500 hover:text-black w-7 h-7 flex items-center justify-center" onclick="closeCartModal()">&times;</button>
    </div>
    <div class="flex-1 overflow-y-auto p-5" id="cartBody">
        <div id="cartEmpty" class="p-3 mb-3 rounded bg-blue-50 text-blue-700 border-l-4 border-blue-500 text-xs">Cart is empty</div>
        <div id="cartItems"></div>
        <div id="pickUpPointGroup" class="hidden mt-4">
            <label for="pickUpPointSelect" class="block text-xs font-semibold mb-1.5">Pick-up Point</label>
            <select id="pickUpPointSelect" class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500">
                <option th:each="p : ${pickuppoints}" th:value="${p.id}" th:text="${p.address}"></option>
            </select>
        </div>
    </div>
    <div class="flex flex-col gap-2.5 px-4 py-3 border-t bg-gray-100">
        <div id="cartTotal" class="font-bold text-sm w-full">Total: 0.00 ‚ÇΩ</div>
        <div class="flex gap-2.5 w-full">
            <button class="flex-1 px-4 py-2 text-xs font-semibold rounded bg-gray-200 text-gray-700 hover:bg-gray-300" onclick="clearCartItems()">Clear</button>
            <button class="flex-1 px-4 py-2 text-xs font-semibold rounded bg-emerald-500 text-white hover:bg-emerald-600" onclick="createOrder()">Place Order</button>
        </div>
    </div>
</div>

<!-- ORDERS SIDEBAR MENU -->
<div id="ordersOverlay" class="fixed inset-0 z-40 bg-black/50 hidden" onclick="closeOrdersModal()"></div>
<div id="ordersSidebar" class="fixed top-0 right-0 z-50 h-full w-[500px] bg-white shadow-xl transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col">
    <div class="flex justify-between items-center px-4 py-3 border-b bg-gray-100">
        <h2 class="text-base font-semibold">üìã My Orders</h2>
        <button class="text-xl text-gray-500 hover:text-black w-7 h-7 flex items-center justify-center" onclick="closeOrdersModal()">&times;</button>
    </div>
    <div class="flex-1 overflow-y-auto p-5" id="ordersBody">
        <div id="ordersEmpty" class="p-3 mb-3 rounded bg-blue-50 text-blue-700 border-l-4 border-blue-500 text-xs">You don't have any orders yet</div>
        <div id="ordersItems"></div>
    </div>
</div>

<script>
    // Get user role from Thymeleaf
    const userRole = /*[[${userRole.name()}]]*/ 'USER';

    function openEditModal(button) {
        const p = button.dataset; // p.id, p.title, ...

        const form = document.getElementById('editForm');
        form.action = form.action + p.id;

        // hidden/text fields
        document.getElementById('editTitle').value       = p.title || '';
        document.getElementById('editDescription').value = p.description || '';
        document.getElementById('editCost').value        = p.cost || '';
        document.getElementById('editQuantity').value    = p.quantityinstock || '';

        // selects
        const categorySelect     = document.getElementById('editCategory');
        const unitSelect         = document.getElementById('editUnit');
        const manufacturerSelect = document.getElementById('editManufacturer');
        const supplierSelect     = document.getElementById('editSupplier');

        if (categorySelect && p.category)        categorySelect.value = p.category;
        if (unitSelect && p.unittype)           unitSelect.value = p.unittype;
        if (manufacturerSelect && p.manufacturer) manufacturerSelect.value = p.manufacturer;
        if (supplierSelect && p.supplier)       supplierSelect.value = p.supplier;

        // discounts
        document.getElementById('editMaxDiscount').value     = p.maxDiscountAmount || '';
        document.getElementById('editCurrentDiscount').value = p.discount || '';

        // show modal
        document.getElementById('editModal').classList.add('active');
    }

    function closeEditModal() {
        document.getElementById('editModal').classList.remove('active');
    }

    // --- submit editForm via fetch, without redirect ---
    const editForm = document.getElementById('editForm');
    if (editForm) {
        editForm.addEventListener('submit', function (e) {
            e.preventDefault();

            const url = this.action;
            const formData = new URLSearchParams(new FormData(editForm));

            fetch(url, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
                body: formData
            }).then(resp => {
                if (resp.ok) {
                    return resp.json();
                } else {
                    alert('Update error: ' + resp.status);
                    throw new Error('Update failed');
                }
            }).then(product => {
                // Update product card in DOM
                updateProductCardInDOM(product);
                alert("Successfully updated");
                document.getElementById('editModal').classList.remove('active');
            }).catch(err => {
                console.error(err);
                if (err.message !== 'Update failed') {
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ');
                }
            });
        });
    }

    // call from "Save" button
    function submitEditForm() {
        if (editForm) {
            editForm.requestSubmit();
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤ –ø–æ ID
    function getCategoryName(id) {
        const select = document.getElementById('editCategory');
        const option = select?.querySelector(`option[value="${id}"]`);
        return option ? option.textContent : '';
    }

    function getManufacturerName(id) {
        const select = document.getElementById('editManufacturer');
        const option = select?.querySelector(`option[value="${id}"]`);
        return option ? option.textContent : '';
    }

    function getUnitTypeName(id) {
        const select = document.getElementById('editUnit');
        const option = select?.querySelector(`option[value="${id}"]`);
        return option ? option.textContent : '';
    }

    function getSupplierName(id) {
        const select = document.getElementById('editSupplier');
        const option = select?.querySelector(`option[value="${id}"]`);
        return option ? option.textContent : '';
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è HTML –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–∞
    function createProductCardHTML(data) {
        const hasDiscount = data.discountAmount > 15;
        const finalPrice = hasDiscount ? data.cost * (100 - data.discountAmount) / 100 : data.cost;
        const priceHTML = hasDiscount
            ? `<span class="old-price">${data.cost.toFixed(2)}</span>
               <span class="text-red-600 font-bold ml-2"> ‚Üí ${finalPrice.toFixed(2)}</span>`
            : `<span>${data.cost.toFixed(2)}</span>`;

        const manufacturerName = data.manufacturer?.title || getManufacturerName(data.manufacturerId) || '';

        // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏
        const editButton = userRole !== 'USER' ? `
            <button class="px-2.5 py-1 text-[11px] rounded border border-emerald-600 bg-emerald-500 text-white hover:bg-emerald-600 cursor-pointer"
                    type="button"
                    data-id="${data.id}"
                    data-title="${data.title}"
                    data-description="${data.description || ''}"
                    data-category="${data.category?.id || data.categoryId || ''}"
                    data-cost="${data.cost}"
                    data-quantityinstock="${data.quantityInStock}"
                    data-unittype="${data.unitType?.id || data.unitTypeId || ''}"
                    data-manufacturer="${data.manufacturer?.id || data.manufacturerId || ''}"
                    data-supplier="${data.supplier?.id || data.supplierId || ''}"
                    data-discount="${data.discountAmount}"
                    data-max-discount-amount="${data.maxDiscountAmount}"
                    onclick="openEditModal(this)">
                –ò–∑–º–µ–Ω–∏—Ç—å
            </button>` : '';

        const deleteButton = userRole !== 'USER' ? `
            <button class="px-2.5 py-1 text-[11px] rounded border border-red-500 bg-red-500 text-white hover:bg-red-600 cursor-pointer delete-btn"
                    data-id="${data.id}">
                –£–¥–∞–ª–∏—Ç—å
            </button>` : '';

        return `
            <div class="grid grid-cols-[120px_1fr_120px] gap-5 border border-gray-800 p-4 bg-white rounded" data-product-id="${data.id}">
                <!-- –§–æ—Ç–æ -->
                <div class="flex items-center">
                    <div class="border border-gray-800 p-5 w-full min-h-[100px] flex items-center justify-center bg-gray-100">
                        <img src="/picture.png" alt="–ù–µ—Ç —Ñ–æ—Ç–æ" class="max-w-full max-h-full">
                    </div>
                </div>

                <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                <div class="flex flex-col justify-center">
                    <div class="font-bold mb-2 text-sm">${data.title}</div>
                    <div class="mb-1.5 text-xs">
                        <span class="font-semibold">–û–ø–∏—Å–∞–Ω–∏–µ: </span>
                        <span>${data.description || ''}</span>
                    </div>
                    <div class="mb-1.5 text-xs">
                        <span class="font-semibold">–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å: </span>
                        <span>${manufacturerName}</span>
                    </div>
                    <div class="mb-1.5 text-xs">
                        <span class="font-semibold">–¶–µ–Ω–∞: </span>
                        ${priceHTML}
                    </div>
                    <div class="flex gap-1.5 mt-2">
                        ${editButton}
                        ${deleteButton}
                        <button class="px-2.5 py-1 text-[11px] rounded border border-emerald-600 bg-emerald-500 text-white hover:bg-emerald-600 cursor-pointer"
                                type="button"
                                data-id="${data.id}"
                                data-title="${data.title}"
                                data-cost="${data.cost}"
                                data-discount="${data.discountAmount}"
                                onclick="addToCart(this)">
                            üõí –í –∫–æ—Ä–∑–∏–Ω—É
                        </button>
                    </div>
                </div>

                <!-- –†–∞–∑–º–µ—Ä —Å–∫–∏–¥–∫–∏ -->
                <div class="flex items-center">
                    <div class="flex flex-col items-center justify-center w-full border border-gray-800 py-5 px-2.5 min-h-[100px]">
                        <span class="font-semibold text-xs">–†–∞–∑–º–µ—Ä</span>
                        <span class="font-semibold text-xs">—Å–∫–∏–¥–∫–∏</span>
                        <span class="mt-1.5 text-xl font-bold ${hasDiscount ? 'text-green-600' : ''}">${data.discountAmount}%</span>
                    </div>
                </div>
            </div>
        `;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –≤ DOM
    function addProductCardToDOM(data) {
        const productsContainer = document.querySelector('.p-4.space-y-3');
        if (productsContainer) {
            const cardHTML = createProductCardHTML(data);
            productsContainer.insertAdjacentHTML('beforeend', cardHTML);
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–∞ –≤ DOM
    function updateProductCardInDOM(data) {
        const existingCard = document.querySelector(`[data-product-id="${data.id}"]`);
        if (existingCard) {
            const cardHTML = createProductCardHTML(data);
            existingCard.outerHTML = cardHTML;
        }
    }

    // –ú–æ–¥–∞–ª–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
    function openAddModal() {
        document.getElementById('addModal').classList.add('active');
    }

    const addForm = document.getElementById('addForm');
    if (addForm) {
        addForm.addEventListener('submit', function (e) {
            e.preventDefault();

            const url = this.action;
            const formData = new URLSearchParams(new FormData(addForm));

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
                },
                body: formData
            }).then(resp => {
                if (resp.ok) {
                    return resp.json();
                } else {
                    alert('Add error: ' + resp.status);
                    throw new Error('Add failed');
                }
            }).then(product => {
                // Add new product card to DOM
                addProductCardToDOM(product);
                alert("Successfully added");
                addForm.reset();
                document.getElementById('addModal').classList.remove('active');
            }).catch(err => {
                console.error(err);
                if (err.message !== 'Add failed') {
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ');
                }
            });
        });
    }

    function submitAddForm() {
        if (addForm) {
            addForm.requestSubmit();
        }
    }

    function closeAddModal() {
        document.getElementById('addModal').classList.remove('active');
    }

    document.addEventListener('click', async function (e) {
        if (!e.target.classList.contains('delete-btn')) return;

        const id = e.target.getAttribute('data-id');
        if (!confirm('–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å?')) return;

        const response = await fetch('/products/delete/' + id, {
            method: 'DELETE'
        });

        if (response.ok) {
            // –ù–∞—Ö–æ–¥–∏–º –∏ —É–¥–∞–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É —Ç–æ–≤–∞—Ä–∞ –∏–∑ DOM
            const productCard = document.querySelector(`[data-product-id="${id}"]`);
            if (productCard) {
                productCard.remove();
            }
            alert('Deleted');
        } else {
            alert('Delete error: ' + response.status);
        }
    });

    window.onclick = function(event) {
        const editModal = document.getElementById('editModal');
        const addModal  = document.getElementById('addModal');

        if (event.target === editModal) {
            editModal.classList.remove('active');
        }
        if (event.target === addModal) {
            addModal.classList.remove('active');
        }
    }

    // –ü–æ–∏—Å–∫ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
    const searchInput = document.getElementById('searchInput');
    const sortSelect  = document.getElementById('sortSelect');
    let searchTimer;

    if (searchInput) {
        searchInput.addEventListener('input', function () {
            clearTimeout(searchTimer);
            searchTimer = setTimeout(() => {
                document.getElementById('searchForm').submit();
            }, 500);
        });
    }

    if (sortSelect) {
        sortSelect.addEventListener('change', function () {
            document.getElementById('searchForm').submit();
        });
    }

    // ===================== –ö–û–†–ó–ò–ù–ê =====================

    // –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∫–æ—Ä–∑–∏–Ω—ã
    let cart = JSON.parse(localStorage.getItem('cart') || '[]');

    // Open cart sidebar menu
    function openCartModal() {
        document.getElementById('cartOverlay').classList.remove('hidden');
        document.getElementById('cartSidebar').classList.remove('translate-x-full');
        renderCart();
    }

    // Close cart sidebar menu
    function closeCartModal() {
        document.getElementById('cartOverlay').classList.add('hidden');
        document.getElementById('cartSidebar').classList.add('translate-x-full');
    }

    // Add product to cart
    function addToCart(btn) {
        const id = btn.getAttribute('data-id');
        const title = btn.getAttribute('data-title');
        const cost = parseFloat(btn.getAttribute('data-cost'));
        const discount = parseInt(btn.getAttribute('data-discount') || '0');

        // Calculate price with discount
        const finalCost = discount > 15 ? cost * (100 - discount) / 100 : cost;

        // Check if product is already in cart
        const existingItem = cart.find(item => item.id === id);
        if (existingItem) {
            existingItem.quantity++;
        } else {
            cart.push({
                id: id,
                title: title,
                cost: cost,
                discount: discount,
                finalCost: finalCost,
                quantity: 1
            });
        }

        saveCart();
        alert('Product added to cart');
    }

    // Save cart to localStorage
    function saveCart() {
        localStorage.setItem('cart', JSON.stringify(cart));
    }

    // Render cart
    function renderCart() {
        const cartItems = document.getElementById('cartItems');
        const cartEmpty = document.getElementById('cartEmpty');
        const cartTotal = document.getElementById('cartTotal');
        const pickUpPointGroup = document.getElementById('pickUpPointGroup');

        if (cart.length === 0) {
            cartItems.innerHTML = '';
            cartEmpty.classList.remove('hidden');
            pickUpPointGroup.classList.add('hidden');
            cartTotal.textContent = '–ò—Ç–æ–≥–æ: 0.00 ‚ÇΩ';
            return;
        }

        cartEmpty.classList.add('hidden');
        pickUpPointGroup.classList.remove('hidden');

        let html = '';
        let total = 0;

        cart.forEach((item, index) => {
            const itemTotal = item.finalCost * item.quantity;
            total += itemTotal;

            html += `
                <div class="flex justify-between items-center border border-gray-200 rounded p-3 mb-2 bg-gray-50">
                    <div class="flex-1">
                        <div class="font-semibold text-sm mb-1">${item.title}</div>
                        <div class="text-xs text-gray-600">
                            ${item.discount > 15
                                ? `<span class="old-price">${item.cost.toFixed(2)} ‚ÇΩ</span>
                                   <span class="text-red-600 font-bold ml-2">${item.finalCost.toFixed(2)} ‚ÇΩ</span>
                                   <span class="text-green-600 ml-1">-${item.discount}%</span>`
                                : `<span>${item.cost.toFixed(2)} ‚ÇΩ</span>`
                            }
                        </div>
                    </div>
                    <div class="flex flex-col items-end gap-1">
                        <div class="flex items-center gap-1">
                            <button class="w-6 h-6 text-xs rounded bg-gray-200 hover:bg-gray-300" onclick="changeQuantity(${index}, -1)">‚àí</button>
                            <span class="min-w-[30px] text-center text-sm">${item.quantity}</span>
                            <button class="w-6 h-6 text-xs rounded bg-gray-200 hover:bg-gray-300" onclick="changeQuantity(${index}, 1)">+</button>
                        </div>
                        <div class="font-bold text-sm">${itemTotal.toFixed(2)} ‚ÇΩ</div>
                        <button class="text-red-500 hover:text-red-700 text-xs" onclick="removeFromCart(${index})">‚úï Remove</button>
                    </div>
                </div>
            `;
        });

        cartItems.innerHTML = html;
        cartTotal.textContent = `Total: ${total.toFixed(2)} ‚ÇΩ`;
    }

    // Change product quantity in cart
    function changeQuantity(index, delta) {
        cart[index].quantity += delta;
        if (cart[index].quantity <= 0) {
            cart.splice(index, 1);
        }
        saveCart();
        renderCart();
    }

    // Remove product from cart
    function removeFromCart(index) {
        cart.splice(index, 1);
        saveCart();
        renderCart();
    }

    // Clear cart
    function clearCartItems() {
        if (!confirm('Clear cart?')) return;
        cart = [];
        saveCart();
        renderCart();
    }

    // –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ —á–µ—Ä–µ–∑ API
    async function createOrder() {
        if (cart.length === 0) {
            alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞');
            return;
        }

        const pickUpPointSelect = document.getElementById('pickUpPointSelect');
        const pickUpPointId = pickUpPointSelect ? parseInt(pickUpPointSelect.value) : null;

        if (!pickUpPointId) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏');
            return;
        }

        // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∑–∞–∫–∞–∑–∞ —Å–æ–≥–ª–∞—Å–Ω–æ RequestOrderDto
        const productIdCountCollection = cart.map(item => ({
            productId: item.id,
            count: item.quantity
        }));

        const today = new Date();
        const deliveryDate = new Date(today);
        deliveryDate.setDate(deliveryDate.getDate() + 7);

        const orderData = {
            pickUpPointId: pickUpPointId,
            createDate: today.toISOString().split('T')[0],
            deliveryDate: deliveryDate.toISOString().split('T')[0],
            username: null,
            productIdCountCollection: productIdCountCollection
        };

        try {
            const response = await fetch('/orders/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(orderData)
            });

            if (response.ok) {
                const order = await response.json();
                alert(`Order #${order.id} successfully created!`);
                cart = [];
                saveCart();
                renderCart();
                closeCartModal();
            } else {
                alert('Order creation error: ' + response.status);
            }
        } catch (err) {
            console.error(err);
            alert('Failed to create order');
        }
    }

    // Handler for "Open Cart" button
    document.getElementById('openCartBtn').addEventListener('click', openCartModal);

    // ===================== END OF CART =====================

    // ===================== MY ORDERS =====================

    // Open orders sidebar menu
    async function openOrdersModal() {
        document.getElementById('ordersOverlay').classList.remove('hidden');
        document.getElementById('ordersSidebar').classList.remove('translate-x-full');
        await loadOrders();
    }

    // Close orders sidebar menu
    function closeOrdersModal() {
        document.getElementById('ordersOverlay').classList.add('hidden');
        document.getElementById('ordersSidebar').classList.add('translate-x-full');
    }

    // Load user orders
    async function loadOrders() {
        const ordersItems = document.getElementById('ordersItems');
        const ordersEmpty = document.getElementById('ordersEmpty');

        try {
            const response = await fetch('/orders/my');

            if (!response.ok) {
                throw new Error('Order loading error');
            }

            const orders = await response.json();

            if (orders.length === 0) {
                ordersItems.innerHTML = '';
                ordersEmpty.classList.remove('hidden');
                return;
            }

            ordersEmpty.classList.add('hidden');

            let html = '';
            orders.forEach(order => {
                const statusColors = {
                    'NEW': 'bg-blue-100 text-blue-800',
                    'IN_PROGRESS': 'bg-yellow-100 text-yellow-800',
                    'COMPLETED': 'bg-green-100 text-green-800',
                    'CANCELLED': 'bg-red-100 text-red-800'
                };

                const statusTexts = {
                    'NEW': 'New',
                    'IN_PROGRESS': 'In Progress',
                    'COMPLETED': 'Completed',
                    'CANCELLED': 'Cancelled'
                };

                const statusClass = statusColors[order.status] || 'bg-gray-100 text-gray-800';
                const statusText = statusTexts[order.status] || order.status;

                // Calculate total order cost
                let totalCost = 0;
                let productsHtml = '';

                order.products.forEach(product => {
                    const discount = product.discountAmount || 0;
                    const finalPrice = discount > 15 ? product.cost * (100 - discount) / 100 : product.cost;
                    totalCost += finalPrice * (product.quantity || 1);

                    productsHtml += `
                        <div class="flex justify-between items-center text-xs mb-1 pb-1 border-b border-gray-100">
                            <span class="flex-1">${product.title}</span>
                            <span class="text-gray-600 mx-2">√ó${product.quantity || 1}</span>
                            <span class="font-semibold">${finalPrice.toFixed(2)} ‚ÇΩ</span>
                        </div>
                    `;
                });

                html += `
                    <div class="border border-gray-200 rounded p-3 mb-3 bg-white shadow-sm">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <div class="font-bold text-sm">Order #${order.id}</div>
                                <div class="text-xs text-gray-600 mt-1">
                                    <div>Created: ${formatDate(order.createDate)}</div>
                                    <div>Delivery: ${formatDate(order.deliveryDate)}</div>
                                </div>
                            </div>
                            <span class="px-2 py-1 text-xs rounded ${statusClass} font-semibold">
                                ${statusText}
                            </span>
                        </div>

                        <div class="mb-2">
                            <div class="text-xs font-semibold text-gray-700 mb-1">Pick-up Point:</div>
                            <div class="text-xs text-gray-600">${order.pickUpPoint.address}</div>
                        </div>

                        <div class="mb-2">
                            <div class="text-xs font-semibold text-gray-700 mb-1">Products:</div>
                            <div class="bg-gray-50 p-2 rounded">
                                ${productsHtml}
                            </div>
                        </div>

                        <div class="flex justify-between items-center pt-2 border-t border-gray-200">
                            <span class="text-xs font-semibold">Pickup Code:</span>
                            <span class="font-mono font-bold text-sm text-emerald-600">${order.getCode}</span>
                        </div>

                        <div class="flex justify-between items-center pt-2 mt-2 border-t border-gray-200">
                            <span class="text-sm font-bold">Total:</span>
                            <span class="text-sm font-bold text-emerald-600">${totalCost.toFixed(2)} ‚ÇΩ</span>
                        </div>
                    </div>
                `;
            });

            ordersItems.innerHTML = html;
        } catch (err) {
            console.error(err);
            ordersEmpty.classList.remove('hidden');
            ordersEmpty.textContent = 'Order loading error';
            ordersEmpty.classList.remove('text-blue-700', 'border-blue-500', 'bg-blue-50');
            ordersEmpty.classList.add('text-red-700', 'border-red-500', 'bg-red-50');
        }
    }

    // Date formatting
    function formatDate(dateString) {
        const date = new Date(dateString);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}.${month}.${year}`;
    }

    // Handler for "My Orders" button
    document.getElementById('openOrdersBtn').addEventListener('click', openOrdersModal);

    // ===================== END OF MY ORDERS =====================

        async function removeItem(btn) {
        const id = btn.getAttribute('data-id');
        if (!confirm('Delete item?')) return;

        const resp = await fetch('/cart/items/' + id, { method: 'DELETE' });
        if (resp.ok) {
        btn.closest('.border').remove();
    } else {
        alert('Item deletion error');
    }
    }

        async function clearCart(btn) {
        const orderId = btn.getAttribute('data-id');
        if (!confirm('Clear cart?')) return;

        const resp = await fetch('/cart/' + orderId, { method: 'DELETE' });
        if (resp.ok) {
        // simplest option - reload the page
        location.reload();
    } else {
        alert('Cart clearing error');
    }
    }
</script>
</body>
</html>