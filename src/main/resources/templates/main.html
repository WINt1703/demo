<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–¢–æ–≤–∞—Ä—ã</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .modal { display: none; }
        .modal.active { display: flex; }
        .old-price {
            text-decoration: line-through;
            text-decoration-color: red;
            text-decoration-thickness: 2px;
        }
    </style>
</head>
<body class="font-sans bg-gray-100">
<!-- Top Bar -->
<div class="flex justify-between items-center px-4 py-3 bg-gray-100 border-b border-gray-300">
    <div class="font-semibold text-sm" th:text="${userName}">–ú–∞–π—è</div>
    <div class="flex gap-2">
        <button type="button" id="openCartBtn" class="px-3 py-1.5 text-xs rounded border border-emerald-600 bg-white text-emerald-600 hover:bg-emerald-50 cursor-pointer">
            üõí –ö–æ—Ä–∑–∏–Ω–∞
        </button>
        <button class="px-3 py-1.5 text-xs rounded border border-emerald-600 bg-emerald-500 text-white hover:bg-emerald-600 cursor-pointer" type="button" onclick="openAddModal()">+ –¢–æ–≤–∞—Ä</button>
        <button class="px-3 py-1.5 text-xs rounded border border-gray-300 bg-white text-gray-600 hover:bg-gray-100 cursor-pointer" onclick="history.back()">–ù–∞–∑–∞–¥</button>
    </div>
</div>

<!-- Filters -->
<div class="flex gap-2 px-4 py-2.5 bg-white border-b border-gray-300">
    <form th:action="@{/}" method="get" id="searchForm" class="flex gap-2 w-full">
        <input type="text"
               name="search"
               id="searchInput"
               class="flex-1 px-2.5 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500"
               th:value="${param.search != null ? param.search[0] : ''}"
               placeholder="–ü–æ–∏—Å–∫...">

        <select name="sort" id="sortSelect" th:value="${param.sort != null ? param.sort[0] : ''}"
                class="px-2.5 py-1.5 text-xs border border-gray-300 rounded cursor-pointer focus:outline-none focus:ring-2 focus:ring-emerald-500">
            <option value="">—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</option>
            <option value="titleAsc">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é (–ê‚Äë–Ø)</option>
            <option value="titleDesc">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é (–Ø‚Äë–ê)</option>
            <option value="costAsc">–ü–æ —Ü–µ–Ω–µ (–¥–µ—à–µ–≤—ã–µ)</option>
            <option value="costDesc">–ü–æ —Ü–µ–Ω–µ (–¥–æ—Ä–æ–≥–∏–µ)</option>
        </select>
    </form>
</div>

<!-- Products List -->
<div class="p-4 space-y-3">
    <div class="grid grid-cols-[120px_1fr_120px] gap-5 border border-gray-800 p-4 bg-white rounded" th:each="product : ${products}" th:data-product-id="${product.id}">
        <!-- –§–æ—Ç–æ -->
        <div class="flex items-center">
            <div class="border border-gray-800 p-5 w-full min-h-[100px] flex items-center justify-center bg-gray-100">
                <img th:if="${product.photo != null}"
                     th:src="${@imageHelper.convertImageBytesToBase64(product.photo)}"
                     alt="–§–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞"
                     class="max-w-full max-h-full">
                <img th:if="${product.photo == null}"
                     th:src="@{/picture.png}"
                     alt="–ù–µ—Ç —Ñ–æ—Ç–æ"
                     class="max-w-full max-h-full">
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="flex flex-col justify-center">
            <div class="font-bold mb-2 text-sm" th:text="${product.title}">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</div>
            <div class="mb-1.5 text-xs">
                <span class="font-semibold">–û–ø–∏—Å–∞–Ω–∏–µ: </span>
                <span th:text="${product.description}">–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</span>
            </div>
            <div class="mb-1.5 text-xs">
                <span class="font-semibold">–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å: </span>
                <span th:text="${product.manufacturer.title}">–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å</span>
            </div>
            <div class="mb-1.5 text-xs">
                <span class="font-semibold">–¶–µ–Ω–∞: </span>
                <span th:classappend="${product.discountAmount > 15} ? 'old-price'" th:text="${#numbers.formatDecimal(product.cost, 1, 2, 'DEFAULT')}">0.00</span>
                <span class="text-red-600 font-bold ml-2" th:if="${product.discountAmount > 15}" th:text="' ‚Üí ' + ${#numbers.formatDecimal(product.cost * (100 - product.discountAmount) / 100, 1, 2, 'DEFAULT')}"></span>
            </div>
            <div class="flex gap-1.5 mt-2">
                <button class="px-2.5 py-1 text-[11px] rounded border border-emerald-600 bg-emerald-500 text-white hover:bg-emerald-600 cursor-pointer"
                        type="button"
                        th:attr="
                            data-id=${product.id},
                            data-title=${product.title},
                            data-description=${product.description},
                            data-category=${product.category.id},
                            data-cost=${product.cost},
                            data-quantityInStock=${product.quantityInStock},
                            data-unittype=${product.unitType.id},
                            data-manufacturer=${product.manufacturer.id},
                            data-supplier=${product.supplier.id},
                            data-discount=${product.discountAmount},
                            data-max-discount-amount=${product.maxDiscountAmount}"
                        onclick="openEditModal(this)">
                    –ò–∑–º–µ–Ω–∏—Ç—å
                </button>
                <button class="px-2.5 py-1 text-[11px] rounded border border-red-500 bg-red-500 text-white hover:bg-red-600 cursor-pointer delete-btn"
                        th:data-id="${product.id}">
                    –£–¥–∞–ª–∏—Ç—å
                </button>
                <button class="px-2.5 py-1 text-[11px] rounded border border-emerald-600 bg-emerald-500 text-white hover:bg-emerald-600 cursor-pointer"
                        type="button"
                        th:data-id="${product.id}"
                        th:data-title="${product.title}"
                        th:data-cost="${product.cost}"
                        th:data-discount="${product.discountAmount}"
                        onclick="addToCart(this)">
                    üõí –í –∫–æ—Ä–∑–∏–Ω—É
                </button>
            </div>
        </div>

        <!-- –†–∞–∑–º–µ—Ä —Å–∫–∏–¥–∫–∏ -->
        <div class="flex items-center">
            <div class="flex flex-col items-center justify-center w-full border border-gray-800 py-5 px-2.5 min-h-[100px]">
                <span class="font-semibold text-xs">–†–∞–∑–º–µ—Ä</span>
                <span class="font-semibold text-xs">—Å–∫–∏–¥–∫–∏</span>
                <span class="mt-1.5 text-xl font-bold" th:classappend="${product.discountAmount > 15} ? 'text-green-600' : ''" th:text="${product.discountAmount + '%'}">0%</span>
            </div>
        </div>
    </div>
</div>

<!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø -->
<div id="editModal" class="modal fixed inset-0 z-50 bg-black/50 items-center justify-center">
    <div class="bg-white w-[90%] max-w-xl rounded shadow-xl max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center px-4 py-3 border-b bg-gray-100">
            <h2 class="text-base font-semibold">–ò–∑–º–µ–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</h2>
            <button class="text-xl text-gray-500 hover:text-black w-7 h-7 flex items-center justify-center" onclick="closeEditModal()">&times;</button>
        </div>
        <div class="p-5">
            <form id="editForm" th:action="@{/products/update/}" method="post" class="space-y-4">
                <div>
                    <label for="editTitle" class="block text-xs font-semibold mb-1.5">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</label>
                    <input type="text" id="editTitle" name="title" class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500">
                </div>
                <div>
                    <label for="editDescription" class="block text-xs font-semibold mb-1.5">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="editDescription" name="description" class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded min-h-[80px] resize-y focus:outline-none focus:ring-2 focus:ring-emerald-500"></textarea>
                </div>
                <div>
                    <label for="editCategory" class="block text-xs font-semibold mb-1.5">–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ç–æ–≤–∞—Ä–∞</label>
                    <select id="editCategory" name="categoryId" class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500">
                        <option th:each="c : ${categories}" th:value="${c.id}" th:text="${c.title}"></option>
                    </select>
                </div>
                <div>
                    <label for="editCost" class="block text-xs font-semibold mb-1.5">–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –µ–¥–∏–Ω–∏—Ü—É</label>
                    <input type="number" id="editCost" name="cost" step="0.01" required class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500">
                </div>
                <div>
                    <label for="editQuantity" class="block text-xs font-semibold mb-1.5">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ —Å–∫–ª–∞–¥–µ</label>
                    <input type="number" id="editQuantity" name="quantity" value="1" class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500">
                </div>
                <div>
                    <label for="editUnit" class="block text-xs font-semibold mb-1.5">–ï–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è</label>
                    <select id="editUnit" name="unitTypeId" class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500">
                        <option th:each="u : ${unittypes}" th:value="${u.id}" th:text="${u.title}"></option>
                    </select>
                </div>
                <div>
                    <label for="editManufacturer" class="block text-xs font-semibold mb-1.5">–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å</label>
                    <select id="editManufacturer" name="manufacturerId" class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500">
                        <option th:each="m : ${manufacturers}" th:value="${m.id}" th:text="${m.title}"></option>
                    </select>
                </div>
                <div>
                    <label for="editSupplier" class="block text-xs font-semibold mb-1.5">–ü–æ—Å—Ç–∞–≤—â–∏–∫</label>
                    <select id="editSupplier" name="supplierId" class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500">
                        <option th:each="s : ${suppliers}" th:value="${s.id}" th:text="${s.title}"></option>
                    </select>
                </div>
                <div>
                    <label for="editMaxDiscount" class="block text-xs font-semibold mb-1.5">–†–∞–∑–º–µ—Ä –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å–∫–∏–¥–∫–∏</label>
                    <input type="number" id="editMaxDiscount" name="maxDiscountAmount" min="0" max="100" required class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500">
                </div>
                <div>
                    <label for="editCurrentDiscount" class="block text-xs font-semibold mb-1.5">–†–∞–∑–º–µ—Ä –¥–µ–π—Å—Ç–≤—É—é—â–µ–π —Å–∫–∏–¥–∫–∏</label>
                    <input type="number" id="editCurrentDiscount" name="discountAmount" min="0" max="100" required class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500">
                </div>
            </form>
        </div>
        <div class="flex gap-2 justify-end px-4 py-3 border-t bg-gray-100">
            <button class="px-4 py-2 text-xs font-semibold rounded bg-gray-200 text-gray-700 hover:bg-gray-300" onclick="closeEditModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="px-4 py-2 text-xs font-semibold rounded bg-emerald-500 text-white hover:bg-emerald-600" type="button" onclick="submitEditForm()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

<!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –î–û–ë–ê–í–õ–ï–ù–ò–Ø –¢–û–í–ê–†–ê -->
<div id="addModal" class="modal fixed inset-0 z-50 bg-black/50 items-center justify-center">
    <div class="bg-white w-[90%] max-w-xl rounded shadow-xl max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center px-4 py-3 border-b bg-gray-100">
            <h2 class="text-base font-semibold">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</h2>
            <button class="text-xl text-gray-500 hover:text-black w-7 h-7 flex items-center justify-center" onclick="closeAddModal()">&times;</button>
        </div>
        <div class="p-5">
            <form id="addForm" th:action="@{/products/create}" method="post" class="space-y-4">
                <div>
                    <label for="addTitle" class="block text-xs font-semibold mb-1.5">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</label>
                    <input type="text" id="addTitle" name="title" class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500">
                </div>
                <div>
                    <label for="addDescription" class="block text-xs font-semibold mb-1.5">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="addDescription" name="description" class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded min-h-[80px] resize-y focus:outline-none focus:ring-2 focus:ring-emerald-500"></textarea>
                </div>
                <div>
                    <label for="addCategory" class="block text-xs font-semibold mb-1.5">–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ç–æ–≤–∞—Ä–∞</label>
                    <select id="addCategory" name="categoryId" class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500">
                        <option th:each="c : ${categories}" th:value="${c.id}" th:text="${c.title}"></option>
                    </select>
                </div>
                <div>
                    <label for="addCost" class="block text-xs font-semibold mb-1.5">–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –µ–¥–∏–Ω–∏—Ü—É</label>
                    <input type="number" id="addCost" name="cost" step="0.01" required class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500">
                </div>
                <div>
                    <label for="addQuantity" class="block text-xs font-semibold mb-1.5">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ —Å–∫–ª–∞–¥–µ</label>
                    <input type="number" id="addQuantity" name="quantity" value="1" class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500">
                </div>
                <div>
                    <label for="addUnit" class="block text-xs font-semibold mb-1.5">–ï–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è</label>
                    <select id="addUnit" name="unitTypeId" class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500">
                        <option th:each="u : ${unittypes}" th:value="${u.id}" th:text="${u.title}"></option>
                    </select>
                </div>
                <div>
                    <label for="addManufacturer" class="block text-xs font-semibold mb-1.5">–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å</label>
                    <select id="addManufacturer" name="manufacturerId" class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500">
                        <option th:each="m : ${manufacturers}" th:value="${m.id}" th:text="${m.title}"></option>
                    </select>
                </div>
                <div>
                    <label for="addSupplier" class="block text-xs font-semibold mb-1.5">–ü–æ—Å—Ç–∞–≤—â–∏–∫</label>
                    <select id="addSupplier" name="supplierId" class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500">
                        <option th:each="s : ${suppliers}" th:value="${s.id}" th:text="${s.title}"></option>
                    </select>
                </div>
                <div>
                    <label for="addMaxDiscount" class="block text-xs font-semibold mb-1.5">–†–∞–∑–º–µ—Ä –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å–∫–∏–¥–∫–∏</label>
                    <input type="number" id="addMaxDiscount" name="maxDiscountAmount" value="20" min="0" max="100" required class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500">
                </div>
                <div>
                    <label for="addCurrentDiscount" class="block text-xs font-semibold mb-1.5">–†–∞–∑–º–µ—Ä –¥–µ–π—Å—Ç–≤—É—é—â–µ–π —Å–∫–∏–¥–∫–∏</label>
                    <input type="number" id="addCurrentDiscount" name="discountAmount" min="0" max="100" required class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500">
                </div>
            </form>
        </div>
        <div class="flex gap-2 justify-end px-4 py-3 border-t bg-gray-100">
            <button class="px-4 py-2 text-xs font-semibold rounded bg-gray-200 text-gray-700 hover:bg-gray-300" onclick="closeAddModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="px-4 py-2 text-xs font-semibold rounded bg-emerald-500 text-white hover:bg-emerald-600" type="button" onclick="submitAddForm()">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
    </div>
</div>

<!-- –ë–û–ö–û–í–û–ï –ú–ï–ù–Æ –ö–û–†–ó–ò–ù–´ -->
<div id="cartOverlay" class="fixed inset-0 z-40 bg-black/50 hidden" onclick="closeCartModal()"></div>
<div id="cartSidebar" class="fixed top-0 right-0 z-50 h-full w-96 bg-white shadow-xl transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col">
    <div class="flex justify-between items-center px-4 py-3 border-b bg-gray-100">
        <h2 class="text-base font-semibold">üõí –ö–æ—Ä–∑–∏–Ω–∞</h2>
        <button class="text-xl text-gray-500 hover:text-black w-7 h-7 flex items-center justify-center" onclick="closeCartModal()">&times;</button>
    </div>
    <div class="flex-1 overflow-y-auto p-5" id="cartBody">
        <div id="cartEmpty" class="p-3 mb-3 rounded bg-blue-50 text-blue-700 border-l-4 border-blue-500 text-xs">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>
        <div id="cartItems"></div>
        <div id="pickUpPointGroup" class="hidden mt-4">
            <label for="pickUpPointSelect" class="block text-xs font-semibold mb-1.5">–ü—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏</label>
            <select id="pickUpPointSelect" class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500">
                <option th:each="p : ${pickuppoints}" th:value="${p.id}" th:text="${p.address}"></option>
            </select>
        </div>
    </div>
    <div class="flex flex-col gap-2.5 px-4 py-3 border-t bg-gray-100">
        <div id="cartTotal" class="font-bold text-sm w-full">–ò—Ç–æ–≥–æ: 0.00 ‚ÇΩ</div>
        <div class="flex gap-2.5 w-full">
            <button class="flex-1 px-4 py-2 text-xs font-semibold rounded bg-gray-200 text-gray-700 hover:bg-gray-300" onclick="clearCartItems()">–û—á–∏—Å—Ç–∏—Ç—å</button>
            <button class="flex-1 px-4 py-2 text-xs font-semibold rounded bg-emerald-500 text-white hover:bg-emerald-600" onclick="createOrder()">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
        </div>
    </div>
</div>

<script>
    function openEditModal(button) {
        const p = button.dataset; // p.id, p.title, ...

        const form = document.getElementById('editForm');
        form.action = form.action + p.id;

        // —Å–∫—Ä—ã—Ç—ã–µ/—Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è
        document.getElementById('editTitle').value       = p.title || '';
        document.getElementById('editDescription').value = p.description || '';
        document.getElementById('editCost').value        = p.cost || '';
        document.getElementById('editQuantity').value    = p.quantityinstock || '';

        // —Å–µ–ª–µ–∫—Ç—ã
        const categorySelect     = document.getElementById('editCategory');
        const unitSelect         = document.getElementById('editUnit');
        const manufacturerSelect = document.getElementById('editManufacturer');
        const supplierSelect     = document.getElementById('editSupplier');

        if (categorySelect && p.category)        categorySelect.value = p.category;
        if (unitSelect && p.unittype)           unitSelect.value = p.unittype;
        if (manufacturerSelect && p.manufacturer) manufacturerSelect.value = p.manufacturer;
        if (supplierSelect && p.supplier)       supplierSelect.value = p.supplier;

        // —Å–∫–∏–¥–∫–∏
        document.getElementById('editMaxDiscount').value     = p.maxDiscountAmount || '';
        document.getElementById('editCurrentDiscount').value = p.discount || '';

        // –ø–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª–∫—É
        document.getElementById('editModal').classList.add('active');
    }

    function closeEditModal() {
        document.getElementById('editModal').classList.remove('active');
    }

    // --- –æ—Ç–ø—Ä–∞–≤–∫–∞ editForm —á–µ—Ä–µ–∑ fetch, –±–µ–∑ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ ---
    const editForm = document.getElementById('editForm');
    if (editForm) {
        editForm.addEventListener('submit', function (e) {
            e.preventDefault();

            const url = this.action;
            const formData = new URLSearchParams(new FormData(editForm));

            fetch(url, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
                body: formData
            }).then(resp => {
                if (resp.ok) {
                    alert("–£—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–æ");
                    document.getElementById('editModal').classList.remove('active');
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏: ' + resp.status);
                }
            }).catch(err => {
                console.error(err);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ');
            });
        });
    }

    // –≤—ã–∑—ã–≤–∞—Ç—å –∏–∑ –∫–Ω–æ–ø–∫–∏ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
    function submitEditForm() {
        if (editForm) {
            editForm.requestSubmit();
        }
    }

    // –ú–æ–¥–∞–ª–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
    function openAddModal() {
        document.getElementById('addModal').classList.add('active');
    }

    const addForm = document.getElementById('addForm');
    if (addForm) {
        addForm.addEventListener('submit', function (e) {
            e.preventDefault();

            const url = this.action;
            const formData = new URLSearchParams(new FormData(addForm));

            fetch(url, {
                method: 'POST', // –∏–ª–∏ this.method, –µ—Å–ª–∏ –≤ —Ñ–æ—Ä–º–µ —Å—Ç–æ–∏—Ç method="post"
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
                },
                body: formData
            }).then(resp => {
                if (resp.ok) {
                    // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                    alert("–£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–Ω–æ");
                    // –º–æ–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É –∏–ª–∏ –æ—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É
                    addForm.reset();
                    document.getElementById('addModal').classList.remove('active');
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏: ' + resp.status);
                }
            }).catch(err => {
                console.error(err);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ');
            });
        });
    }

    function submitAddForm() {
        if (addForm) {
            addForm.requestSubmit();
        }
    }

    function closeAddModal() {
        document.getElementById('addModal').classList.remove('active');
    }

    document.addEventListener('click', async function (e) {
        if (!e.target.classList.contains('delete-btn')) return;

        const id = e.target.getAttribute('data-id'); // –∑–¥–µ—Å—å —É–∂–µ –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω product.id
        if (!confirm('–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å?')) return;

        const response = await fetch('/products/delete/' + id, {
            method: 'DELETE'
        });

        if (response.ok) {
            e.target.closest('tr')?.remove();
            alert('–£–¥–∞–ª–µ–Ω–æ');
        } else {
            alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + response.status);
        }
    });

    window.onclick = function(event) {
        const editModal = document.getElementById('editModal');
        const addModal  = document.getElementById('addModal');

        if (event.target === editModal) {
            editModal.classList.remove('active');
        }
        if (event.target === addModal) {
            addModal.classList.remove('active');
        }
    }

    // –ü–æ–∏—Å–∫ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
    const searchInput = document.getElementById('searchInput');
    const sortSelect  = document.getElementById('sortSelect');
    let searchTimer;

    if (searchInput) {
        searchInput.addEventListener('input', function () {
            clearTimeout(searchTimer);
            searchTimer = setTimeout(() => {
                document.getElementById('searchForm').submit();
            }, 500);
        });
    }

    if (sortSelect) {
        sortSelect.addEventListener('change', function () {
            document.getElementById('searchForm').submit();
        });
    }

    // ===================== –ö–û–†–ó–ò–ù–ê =====================

    // –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∫–æ—Ä–∑–∏–Ω—ã
    let cart = JSON.parse(localStorage.getItem('cart') || '[]');

    // –û—Ç–∫—Ä—ã—Ç—å –±–æ–∫–æ–≤–æ–µ –º–µ–Ω—é –∫–æ—Ä–∑–∏–Ω—ã
    function openCartModal() {
        document.getElementById('cartOverlay').classList.remove('hidden');
        document.getElementById('cartSidebar').classList.remove('translate-x-full');
        renderCart();
    }

    // –ó–∞–∫—Ä—ã—Ç—å –±–æ–∫–æ–≤–æ–µ –º–µ–Ω—é –∫–æ—Ä–∑–∏–Ω—ã
    function closeCartModal() {
        document.getElementById('cartOverlay').classList.add('hidden');
        document.getElementById('cartSidebar').classList.add('translate-x-full');
    }

    // –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä –≤ –∫–æ—Ä–∑–∏–Ω—É
    function addToCart(btn) {
        const id = btn.getAttribute('data-id');
        const title = btn.getAttribute('data-title');
        const cost = parseFloat(btn.getAttribute('data-cost'));
        const discount = parseInt(btn.getAttribute('data-discount') || '0');

        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—É —Å–æ —Å–∫–∏–¥–∫–æ–π
        const finalCost = discount > 15 ? cost * (100 - discount) / 100 : cost;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π —Ç–æ–≤–∞—Ä –≤ –∫–æ—Ä–∑–∏–Ω–µ
        const existingItem = cart.find(item => item.id === id);
        if (existingItem) {
            existingItem.quantity++;
        } else {
            cart.push({
                id: id,
                title: title,
                cost: cost,
                discount: discount,
                finalCost: finalCost,
                quantity: 1
            });
        }

        saveCart();
        alert('–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É');
    }

    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É –≤ localStorage
    function saveCart() {
        localStorage.setItem('cart', JSON.stringify(cart));
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã
    function renderCart() {
        const cartItems = document.getElementById('cartItems');
        const cartEmpty = document.getElementById('cartEmpty');
        const cartTotal = document.getElementById('cartTotal');
        const pickUpPointGroup = document.getElementById('pickUpPointGroup');

        if (cart.length === 0) {
            cartItems.innerHTML = '';
            cartEmpty.classList.remove('hidden');
            pickUpPointGroup.classList.add('hidden');
            cartTotal.textContent = '–ò—Ç–æ–≥–æ: 0.00 ‚ÇΩ';
            return;
        }

        cartEmpty.classList.add('hidden');
        pickUpPointGroup.classList.remove('hidden');

        let html = '';
        let total = 0;

        cart.forEach((item, index) => {
            const itemTotal = item.finalCost * item.quantity;
            total += itemTotal;

            html += `
                <div class="flex justify-between items-center border border-gray-200 rounded p-3 mb-2 bg-gray-50">
                    <div class="flex-1">
                        <div class="font-semibold text-sm mb-1">${item.title}</div>
                        <div class="text-xs text-gray-600">
                            ${item.discount > 15
                                ? `<span class="old-price">${item.cost.toFixed(2)} ‚ÇΩ</span>
                                   <span class="text-red-600 font-bold ml-2">${item.finalCost.toFixed(2)} ‚ÇΩ</span>
                                   <span class="text-green-600 ml-1">-${item.discount}%</span>`
                                : `<span>${item.cost.toFixed(2)} ‚ÇΩ</span>`
                            }
                        </div>
                    </div>
                    <div class="flex flex-col items-end gap-1">
                        <div class="flex items-center gap-1">
                            <button class="w-6 h-6 text-xs rounded bg-gray-200 hover:bg-gray-300" onclick="changeQuantity(${index}, -1)">‚àí</button>
                            <span class="min-w-[30px] text-center text-sm">${item.quantity}</span>
                            <button class="w-6 h-6 text-xs rounded bg-gray-200 hover:bg-gray-300" onclick="changeQuantity(${index}, 1)">+</button>
                        </div>
                        <div class="font-bold text-sm">${itemTotal.toFixed(2)} ‚ÇΩ</div>
                        <button class="text-red-500 hover:text-red-700 text-xs" onclick="removeFromCart(${index})">‚úï –£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </div>
            `;
        });

        cartItems.innerHTML = html;
        cartTotal.textContent = `–ò—Ç–æ–≥–æ: ${total.toFixed(2)} ‚ÇΩ`;
    }

    // –ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ
    function changeQuantity(index, delta) {
        cart[index].quantity += delta;
        if (cart[index].quantity <= 0) {
            cart.splice(index, 1);
        }
        saveCart();
        renderCart();
    }

    // –£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã
    function removeFromCart(index) {
        cart.splice(index, 1);
        saveCart();
        renderCart();
    }

    // –û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É
    function clearCartItems() {
        if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É?')) return;
        cart = [];
        saveCart();
        renderCart();
    }

    // –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ —á–µ—Ä–µ–∑ API
    async function createOrder() {
        if (cart.length === 0) {
            alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞');
            return;
        }

        const pickUpPointSelect = document.getElementById('pickUpPointSelect');
        const pickUpPointId = pickUpPointSelect ? parseInt(pickUpPointSelect.value) : null;

        if (!pickUpPointId) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏');
            return;
        }

        // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∑–∞–∫–∞–∑–∞ —Å–æ–≥–ª–∞—Å–Ω–æ RequestOrderDto
        const productIdCountCollection = cart.map(item => ({
            productId: item.id,
            count: item.quantity
        }));

        const today = new Date();
        const deliveryDate = new Date(today);
        deliveryDate.setDate(deliveryDate.getDate() + 7);

        const orderData = {
            pickUpPointId: pickUpPointId,
            createDate: today.toISOString().split('T')[0],
            deliveryDate: deliveryDate.toISOString().split('T')[0],
            username: null,
            productIdCountCollection: productIdCountCollection
        };

        try {
            const response = await fetch('/orders/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(orderData)
            });

            if (response.ok) {
                const order = await response.json();
                alert(`–ó–∞–∫–∞–∑ #${order.id} —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!`);
                cart = [];
                saveCart();
                renderCart();
                closeCartModal();
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞: ' + response.status);
            }
        } catch (err) {
            console.error(err);
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑');
        }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–û—Ç–∫—Ä—ã—Ç—å –∫–æ—Ä–∑–∏–Ω—É"
    document.getElementById('openCartBtn').addEventListener('click', openCartModal);

    // ===================== –ö–û–ù–ï–¶ –ö–û–†–ó–ò–ù–´ =====================

        async function removeItem(btn) {
        const id = btn.getAttribute('data-id');
        if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é?')) return;

        const resp = await fetch('/cart/items/' + id, { method: 'DELETE' });
        if (resp.ok) {
        btn.closest('.border').remove();
    } else {
        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏');
    }
    }

        async function clearCart(btn) {
        const orderId = btn.getAttribute('data-id');
        if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É?')) return;

        const resp = await fetch('/cart/' + orderId, { method: 'DELETE' });
        if (resp.ok) {
        // –ø—Ä–æ—Å—Ç–µ–π—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç ‚Äì –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
        location.reload();
    } else {
        alert('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã');
    }
    }
</script>
</body>
</html>